<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Course Activation Manager</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    body {
      font-family: 'Segoe UI', Arial, sans-serif;
      background: #f7f9fa;
      margin: 0;
      padding: 0;
    }
    .container {
      max-width: 700px;
      margin: 40px auto;
      background: #fff;
      border-radius: 12px;
      box-shadow: 0 2px 12px rgba(0,0,0,0.08);
      padding: 32px 24px 24px 24px;
    }
    h1 {
      text-align: center;
      color: #2d3a4b;
      margin-bottom: 24px;
    }
    .file-actions {
      display: flex;
      justify-content: center;
      gap: 16px;
      margin-bottom: 24px;
    }
    .file-actions button {
      background: #2563eb;
      color: #fff;
      border: none;
      border-radius: 6px;
      padding: 10px 18px;
      cursor: pointer;
      font-size: 1rem;
      transition: background 0.2s;
    }
    .file-actions button:hover {
      background: #1e40af;
    }
    .courses-list {
      margin-top: 12px;
      margin-bottom: 24px;
    }
    .course-item {
      display: flex;
      align-items: center;
      padding: 10px 0;
      border-bottom: 1px solid #f0f0f0;
    }
    .course-item:last-child {
      border-bottom: none;
    }
    .course-label {
      flex: 1;
      margin-left: 12px;
      font-size: 1.05rem;
      color: #374151;
    }
    .active {
      color: #059669;
      font-weight: 600;
    }
    .inactive {
      color: #b91c1c;
      font-weight: 600;
    }
    .status {
      margin-left: 16px;
      font-size: 0.95rem;
      min-width: 70px;
      text-align: right;
    }
    .save-status {
      text-align: center;
      margin-top: 10px;
      color: #059669;
      font-weight: 500;
      min-height: 24px;
    }
    .instructions {
      text-align: center;
      color: #555;
      font-size: 1.02rem;
      margin-bottom: 10px;
    }
    @media (max-width: 600px) {
      .container { padding: 12px; }
      .file-actions button { padding: 8px 10px; font-size: 0.95rem; }
      .course-label { font-size: 0.97rem; }
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>Course Activation Manager</h1>
    <div class="instructions">
      1. Click <b>Load config/config.yaml</b> and select <b>config/config.yaml</b> from the <b>config/</b> folder.<br>
      2. Edit courses, then click <b>Save Changes</b> to update the file.
    </div>
    <div class="file-actions">
      <button id="loadBtn">Load config/config.yaml</button>
      <button id="saveBtn" disabled>Save Changes</button>
    </div>
    <div class="save-status" id="saveStatus"></div>
    <div class="courses-list" id="coursesList">
      <p style="text-align:center;color:#888;">Press <b>Load config/config.yaml</b> to view and edit courses.</p>
    </div>
  </div>
  <script>
    // --- YAML parsing and stringifying (minimal, for this structure) ---
    function parseCoursesFromYAML(yamlText) {
      // Find the 'courses:' section and parse the indented lines
      const lines = yamlText.split(/[\r\n]+/);
      let inCourses = false;
      const courses = [];
      let courseIndent = null;
      for (let i = 0; i < lines.length; i++) {
        const line = lines[i];
        if (!inCourses) {
          if (/^\s*courses:\s*$/.test(line)) {
            inCourses = true;
            // Next non-empty, non-comment line's indent is the course indent
            for (let j = i+1; j < lines.length; j++) {
              const l = lines[j];
              if (l.trim() && !l.trim().startsWith('#')) {
                courseIndent = l.match(/^(\s*)/)[1].length;
                break;
              }
            }
            continue;
          }
        } else {
          // End of courses section if dedented or empty
          if (!line.trim() || (courseIndent !== null && line.match(/^(\s*)/)[1].length < courseIndent)) break;
          if (line.trim().startsWith('#')) continue;
          // Parse: <course name>: true/false
          const match = line.match(/^\s*(.+?):\s*(true|false)\s*$/i);
          if (match) {
            courses.push({
              name: match[1].trim(),
              active: match[2].toLowerCase() === 'true'
            });
          }
        }
      }
      return courses;
    }

    function updateCoursesInYAML(yamlText, updatedCourses) {
      // Replace the courses section with the updated values
      const lines = yamlText.split(/[\r\n]+/);
      let inCourses = false;
      let courseIndent = null;
      let startIdx = -1, endIdx = -1;
      for (let i = 0; i < lines.length; i++) {
        const line = lines[i];
        if (!inCourses) {
          if (/^\s*courses:\s*$/.test(line)) {
            inCourses = true;
            startIdx = i + 1;
            // Find indent
            for (let j = i+1; j < lines.length; j++) {
              const l = lines[j];
              if (l.trim() && !l.trim().startsWith('#')) {
                courseIndent = l.match(/^(\s*)/)[1];
                break;
              }
            }
            continue;
          }
        } else {
          // End of courses section if dedented or empty
          if (!line.trim() || (courseIndent !== null && line.match(/^(\s*)/)[1].length < courseIndent.length)) {
            endIdx = i;
            break;
          }
        }
      }
      if (inCourses && startIdx !== -1) {
        if (endIdx === -1) endIdx = lines.length;
        // Build new course lines
        const courseLines = updatedCourses.map(c =>
          `${courseIndent}${c.name}: ${c.active ? 'true' : 'false'}`
        );
        // Replace lines
        const newLines = [
          ...lines.slice(0, startIdx),
          ...courseLines,
          ...lines.slice(endIdx)
        ];
        return newLines.join('\n');
      }
      // fallback: return original
      return yamlText;
    }

    // --- UI and File Handling ---
    let yamlText = '';
    let courses = [];
    let fileHandle = null;

    const loadBtn = document.getElementById('loadBtn');
    const saveBtn = document.getElementById('saveBtn');
    const coursesList = document.getElementById('coursesList');
    const saveStatus = document.getElementById('saveStatus');

    // Prompt user to select config/config.yaml manually
    async function getConfigFileHandle() {
      if ('showOpenFilePicker' in window) {
        try {
          const [handle] = await window.showOpenFilePicker({
            types: [{ description: 'YAML Files', accept: { 'application/x-yaml': ['.yaml', '.yml'] } }],
            excludeAcceptAllOption: true
          });
          return handle;
        } catch (e) {
          saveStatus.textContent = 'File open cancelled or failed.';
          return null;
        }
      } else {
        alert('Your browser does not support direct file access. Please use a Chromium-based browser (like Chrome or Edge).');
        return null;
      }
    }

    loadBtn.addEventListener('click', async () => {
      saveStatus.textContent = '';
      fileHandle = await getConfigFileHandle();
      if (!fileHandle) return;
      try {
        const file = await fileHandle.getFile();
        yamlText = await file.text();
        courses = parseCoursesFromYAML(yamlText);
        renderCourses();
        saveBtn.disabled = false;
        saveStatus.textContent = 'Loaded config/config.yaml';
      } catch (e) {
        saveStatus.textContent = 'Failed to read config/config.yaml';
      }
    });

    saveBtn.addEventListener('click', async () => {
      if (!courses.length || !fileHandle) return;
      const newYaml = updateCoursesInYAML(yamlText, courses);
      try {
        const writable = await fileHandle.createWritable();
        await writable.write(newYaml);
        await writable.close();
        saveStatus.textContent = 'Saved to config/config.yaml successfully!';
      } catch (err) {
        saveStatus.textContent = 'Save cancelled or failed.';
      }
    });

    function renderCourses() {
      if (!courses.length) {
        coursesList.innerHTML = '<p style="text-align:center;color:#888;">No courses found in config.yaml.</p>';
        return;
      }
      coursesList.innerHTML = '';
      courses.forEach((course, idx) => {
        const div = document.createElement('div');
        div.className = 'course-item';
        const checkbox = document.createElement('input');
        checkbox.type = 'checkbox';
        checkbox.checked = course.active;
        checkbox.id = 'course-' + idx;
        checkbox.addEventListener('change', () => {
          course.active = checkbox.checked;
          renderCourses(); // update status color
          saveStatus.textContent = 'Unsaved changes';
        });
        const label = document.createElement('label');
        label.htmlFor = checkbox.id;
        label.className = 'course-label';
        label.textContent = course.name;
        const status = document.createElement('span');
        status.className = 'status ' + (course.active ? 'active' : 'inactive');
        status.textContent = course.active ? 'Active' : 'Inactive';
        div.appendChild(checkbox);
        div.appendChild(label);
        div.appendChild(status);
        coursesList.appendChild(div);
      });
    }
  </script>
</body>
</html>
